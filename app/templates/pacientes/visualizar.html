{% extends "base.html" %}

{% block title %}{{ paciente.nome }} - {{ super() }}{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row mb-4">
        <div class="col">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h2 mb-1">
                        <i class="bi bi-person-circle me-2"></i>
                        {{ paciente.nome }}
                        {% if not paciente.ativo %}
                            <span class="badge bg-secondary">Inativo</span>
                        {% endif %}
                    </h1>
                    <p class="text-muted mb-0">
                        <small>ID: {{ paciente.identificacao or '-' }}</small>
                    </p>
                </div>
                <div>
                    <a href="{{ url_for('pacientes.listar') }}" class="btn btn-outline-secondary me-2">
                        <i class="bi bi-arrow-left me-1"></i>
                        Voltar
                    </a>
                    <a href="{{ url_for('pacientes.editar', id=paciente.id) }}" class="btn btn-warning me-2">
                        <i class="bi bi-pencil me-1"></i>
                        Editar
                    </a>
                    {% if paciente.ativo %}
                        <button type="button"
                                class="btn btn-danger"
                                data-bs-toggle="modal"
                                data-bs-target="#modalExcluir">
                            <i class="bi bi-trash me-1"></i>
                            Excluir
                        </button>
                    {% else %}
                        <form method="POST"
                              action="{{ url_for('pacientes.reativar', id=paciente.id) }}"
                              class="d-inline">
                            <button type="submit" class="btn btn-success">
                                <i class="bi bi-arrow-clockwise me-1"></i>
                                Reativar
                            </button>
                        </form>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h3 class="text-primary mb-1">
                        {{ idade_anos }}<small class="text-muted"> anos</small>
                    </h3>
                    {% if idade_meses %}
                        <p class="text-muted mb-0">{{ idade_meses }} mês(es)</p>
                    {% else %}
                        <p class="text-muted mb-0">Idade atual</p>
                    {% endif %}
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h3 class="text-info mb-1">{{ total_avaliacoes }}</h3>
                    <p class="text-muted mb-0">avaliações totais</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h3 class="text-success mb-1">{{ avaliacoes_concluidas }}</h3>
                    <p class="text-muted mb-0">concluídas</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h3 class="text-warning mb-1">{{ avaliacoes_andamento }}</h3>
                    <p class="text-muted mb-0">em andamento</p>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-8">
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="bi bi-clipboard-data me-2"></i>
                        Histórico de Avaliações
                    </h5>
                    <a href="{{ url_for('avaliacoes.nova') }}?paciente_id={{ paciente.id }}" class="btn btn-sm btn-primary">
                        <i class="bi bi-plus-circle me-1"></i>
                        Nova Avaliação
                    </a>
                </div>
                <div class="card-body">
                    {% if avaliacoes %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Data</th>
                                    <th>Instrumento</th>
                                    <th>Avaliador</th>
                                    <th>Status</th>
                                    <th class="text-end">Ações</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for avaliacao in avaliacoes %}
                                <tr>
                                    <td>{{ avaliacao.data_avaliacao.strftime('%d/%m/%Y') }}</td>
                                    <td>{{ avaliacao.instrumento.nome if avaliacao.instrumento else '-' }}</td>
                                    <td>{{ avaliacao.avaliador.nome_completo if avaliacao.avaliador else '-' }}</td>
                                    <td>
                                        {% if avaliacao.status == 'concluida' %}
                                            <span class="badge bg-success">Concluída</span>
                                        {% elif avaliacao.status == 'em_andamento' %}
                                            <span class="badge bg-warning text-dark">Em Andamento</span>
                                        {% elif avaliacao.status == 'revisao' %}
                                            <span class="badge bg-info">Em Revisão</span>
                                        {% else %}
                                            <span class="badge bg-secondary">{{ avaliacao.status }}</span>
                                        {% endif %}
                                    </td>
                                    <td class="text-end">
                                        <a href="{{ url_for('avaliacoes.visualizar', id=avaliacao.id) }}"
                                           class="btn btn-sm btn-outline-primary" title="Ver Detalhes">
                                            <i class="bi bi-eye"></i>
                                        </a>
                                        {% if avaliacao.status == 'em_andamento' %}
                                        <a href="{{ url_for('avaliacoes.responder', id=avaliacao.id) }}"
                                           class="btn btn-sm btn-outline-success" title="Continuar">
                                            <i class="bi bi-play-circle"></i>
                                        </a>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-5 text-muted">
                        <i class="bi bi-clipboard-x" style="font-size: 3rem;"></i>
                        <p class="mt-3">Nenhuma avaliação registrada para este paciente.</p>
                        <a href="{{ url_for('avaliacoes.nova') }}?paciente_id={{ paciente.id }}" class="btn btn-primary">
                            <i class="bi bi-plus-circle me-1"></i>
                            Criar Primeira Avaliação
                        </a>
                    </div>
                    {% endif %}
                </div>
            </div>

            {% if paciente.observacoes %}
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-journal-text me-2"></i>
                        Observações
                    </h5>
                </div>
                <div class="card-body">
                    <p class="mb-0">{{ paciente.observacoes }}</p>
                </div>
            </div>
            {% endif %}
        </div>

        <div class="col-lg-4">
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-info-circle me-2"></i>
                        Informações do Paciente
                    </h5>
                </div>
                <div class="card-body">
                    <dl class="row mb-0">
                        <dt class="col-sm-5">Nome:</dt>
                        <dd class="col-sm-7">{{ paciente.nome }}</dd>

                        <dt class="col-sm-5">Identificação:</dt>
                        <dd class="col-sm-7">{{ paciente.identificacao or '-' }}</dd>

                        <dt class="col-sm-5">Data Nasc.:</dt>
                        <dd class="col-sm-7">{{ paciente.data_nascimento.strftime('%d/%m/%Y') }}</dd>

                        <dt class="col-sm-5">Idade:</dt>
                        <dd class="col-sm-7">
                            {{ idade_anos }} ano(s)
                            {% if idade_meses %}
                                e {{ idade_meses }} mês(es)
                            {% endif %}
                        </dd>

                        <dt class="col-sm-5">Sexo:</dt>
                        <dd class="col-sm-7">
                            {% if paciente.sexo == 'M' %}
                                Masculino
                            {% elif paciente.sexo == 'F' %}
                                Feminino
                            {% else %}
                                Outro
                            {% endif %}
                        </dd>

                        <dt class="col-sm-5">Raça/Etnia:</dt>
                        <dd class="col-sm-7">{{ paciente.raca_etnia or '-' }}</dd>

                        <dt class="col-sm-5">Instrumento Sugerido:</dt>
                        <dd class="col-sm-7">
                            {% if instrumento_adequado %}
                                {{ instrumento_adequado.replace('_', ' ') }}
                            {% else %}
                                <span class="text-muted">Fora da faixa etária dos instrumentos SPM</span>
                            {% endif %}
                        </dd>
                    </dl>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-gear-wide-connected me-2"></i>
                        Ações
                    </h5>
                </div>
                <div class="card-body">
                    {% if paciente.ativo %}
                    <form method="POST"
                          action="{{ url_for('pacientes.excluir', id=paciente.id) }}"
                          onsubmit="return confirm('Tem certeza de que deseja desativar ou excluir este paciente?');">
                        <button type="submit" class="btn btn-danger w-100 mb-2">
                            <i class="bi bi-trash me-1"></i>
                            Excluir ou Desativar
                        </button>
                    </form>
                    {% else %}
                    <form method="POST" action="{{ url_for('pacientes.reativar', id=paciente.id) }}">
                        <button type="submit" class="btn btn-success w-100">
                            <i class="bi bi-arrow-clockwise me-1"></i>
                            Reativar Paciente
                        </button>
                    </form>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalExcluir" tabindex="-1" aria-labelledby="modalExcluirLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalExcluirLabel">Excluir paciente</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>
            <div class="modal-body">
                <p>Deseja desativar ou excluir o paciente <strong>{{ paciente.nome }}</strong>?</p>
                <p class="text-muted mb-0">
                    Caso o paciente possua avaliações, ele será apenas desativado para manter o histórico.
                </p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <form method="POST" action="{{ url_for('pacientes.excluir', id=paciente.id) }}" class="d-inline">
                    <button type="submit" class="btn btn-danger">
                        Confirmar
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}
