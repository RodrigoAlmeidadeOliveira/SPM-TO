{% extends "base.html" %}

{% block title %}Plano Educacional Individualizado{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <!-- Cabeçalho -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h2><i class="bi bi-file-earmark-check me-2"></i>Plano Educacional Individualizado (PEI)</h2>
                <p class="text-muted mb-0">
                    Paciente: <strong>{{ avaliacao.paciente.nome }}</strong> |
                    Avaliação: {{ avaliacao.data_avaliacao.strftime('%d/%m/%Y') }}
                </p>
            </div>
            <div>
                <a href="{{ url_for('pei.selecionar_itens', avaliacao_id=avaliacao.id) }}"
                   class="btn btn-primary">
                    <i class="bi bi-pencil me-1"></i>Editar Seleção
                </a>
                <a href="{{ url_for('pei.gerar_pdf', avaliacao_id=avaliacao.id) }}"
                   class="btn btn-success" target="_blank">
                    <i class="bi bi-file-pdf me-1"></i>Gerar PDF
                </a>
            </div>
        </div>

        <!-- Informações do Paciente -->
        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                <i class="bi bi-person me-2"></i>Informações do Paciente
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <p><strong>Nome:</strong> {{ avaliacao.paciente.nome }}</p>
                        <p><strong>Identificação:</strong> {{ avaliacao.paciente.identificacao }}</p>
                        <p><strong>Data de Nascimento:</strong> {{ avaliacao.paciente.data_nascimento.strftime('%d/%m/%Y') }}</p>
                    </div>
                    <div class="col-md-6">
                        {% set idade_anos, idade_meses = avaliacao.paciente.calcular_idade() %}
                        <p><strong>Idade:</strong> {{ idade_anos }} anos e {{ idade_meses }} meses</p>
                        <p><strong>Sexo:</strong> {{ avaliacao.paciente.get_sexo_display() }}</p>
                        {% if avaliacao.paciente.raca_etnia %}
                        <p><strong>Raça/Etnia:</strong> {{ avaliacao.paciente.raca_etnia }}</p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Informações da Avaliação -->
        <div class="card mb-4">
            <div class="card-header bg-info text-white">
                <i class="bi bi-clipboard-data me-2"></i>Informações da Avaliação
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <p><strong>Instrumento:</strong> {{ avaliacao.instrumento.nome }}</p>
                        <p><strong>Data da Avaliação:</strong> {{ avaliacao.data_avaliacao.strftime('%d/%m/%Y') }}</p>
                        <p><strong>Avaliador:</strong> {{ avaliacao.avaliador.nome_completo }}</p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>Respondente:</strong> {{ avaliacao.relacionamento_respondente or 'Não informado' }}</p>
                        <p><strong>Status:</strong>
                            <span class="badge bg-success">{{ avaliacao.status }}</span>
                        </p>
                        {% if avaliacao.data_conclusao %}
                        <p><strong>Data de Conclusão:</strong> {{ avaliacao.data_conclusao.strftime('%d/%m/%Y') }}</p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Itens do PEI -->
        {% if itens_pei %}
        <div class="card mb-4">
            <div class="card-header bg-success text-white">
                <i class="bi bi-list-check me-2"></i>Objetivos e Estratégias do PEI
                <span class="badge bg-light text-dark float-end">{{ itens_pei|length }} item(ns)</span>
            </div>
            <div class="card-body">
                {% set ns = namespace(dominio_atual='') %}
                {% set ns.contador = 1 %}

                {% for item in itens_pei %}
                    <!-- Cabeçalho do domínio (quando muda) -->
                    {% if item.template_item.dominio_nome != ns.dominio_atual %}
                        {% set ns.dominio_atual = item.template_item.dominio_nome %}
                        <h5 class="mt-4 mb-3 text-primary">
                            <i class="bi bi-folder me-2"></i>{{ ns.dominio_atual }}
                        </h5>
                    {% endif %}

                    <!-- Item do PEI -->
                    <div class="border-start border-5 border-primary ps-3 mb-3">
                        <p class="mb-1">
                            <strong>{{ ns.contador }}.</strong> {{ item.template_item.texto }}
                        </p>

                        {% if item.observacoes %}
                        <div class="alert alert-light mb-0 mt-2 py-2">
                            <small class="text-muted">
                                <i class="bi bi-chat-left-text me-1"></i>
                                <strong>Observações:</strong> {{ item.observacoes }}
                            </small>
                        </div>
                        {% endif %}
                    </div>

                    {% set ns.contador = ns.contador + 1 %}
                {% endfor %}
            </div>
        </div>

        <!-- Informações Adicionais -->
        <div class="card">
            <div class="card-body">
                <p class="text-muted mb-0">
                    <i class="bi bi-info-circle me-2"></i>
                    Este PEI foi gerado com base nos resultados da avaliação SPM realizada em
                    {{ avaliacao.data_avaliacao.strftime('%d/%m/%Y') }}.
                    Os objetivos e estratégias devem ser revisados periodicamente e ajustados conforme
                    o progresso do aluno.
                </p>
            </div>
        </div>

        {% else %}
        <!-- Nenhum item selecionado -->
        <div class="alert alert-warning">
            <i class="bi bi-exclamation-triangle me-2"></i>
            Nenhum item do PEI foi selecionado para esta avaliação.
            <a href="{{ url_for('pei.selecionar_itens', avaliacao_id=avaliacao.id) }}" class="alert-link">
                Clique aqui para selecionar itens
            </a>.
        </div>
        {% endif %}

        <!-- Botão Voltar -->
        <div class="mt-4">
            <a href="{{ url_for('avaliacoes.visualizar', id=avaliacao.id) }}" class="btn btn-secondary">
                <i class="bi bi-arrow-left me-1"></i>Voltar para Avaliação
            </a>
        </div>
    </div>
</div>
{% endblock %}
