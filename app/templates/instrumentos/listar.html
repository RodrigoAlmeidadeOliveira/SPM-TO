{% extends "base.html" %}

{% block title %}Instrumentos - {{ super() }}{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h2 mb-0">
            <i class="bi bi-clipboard-data me-2"></i>
            Instrumentos
        </h1>
        <a href="{{ url_for('instrumentos.novo') }}" class="btn btn-primary">
            <i class="bi bi-plus-circle me-1"></i>
            Novo Instrumento
        </a>
    </div>

    <form method="GET" class="card card-body mb-4">
        <div class="row g-3 align-items-end">
            <div class="col-md-4">
                <label for="busca" class="form-label">Buscar</label>
                <input type="text"
                       class="form-control"
                       id="busca"
                       name="busca"
                       placeholder="Nome ou código..."
                       value="{{ busca }}">
            </div>
            <div class="col-md-3">
                <label for="contexto" class="form-label">Contexto</label>
                <select class="form-select" id="contexto" name="contexto">
                    <option value="">Todos</option>
                    <option value="casa" {% if contexto == 'casa' %}selected{% endif %}>Casa</option>
                    <option value="escola" {% if contexto == 'escola' %}selected{% endif %}>Escola</option>
                    <option value="clinica" {% if contexto == 'clinica' %}selected{% endif %}>Clínica</option>
                    <option value="hospital" {% if contexto == 'hospital' %}selected{% endif %}>Hospital</option>
                    <option value="geral" {% if contexto == 'geral' %}selected{% endif %}>Geral</option>
                    <option value="comunidade" {% if contexto == 'comunidade' %}selected{% endif %}>Comunidade</option>
                </select>
            </div>
            <div class="col-md-3">
                <label for="status" class="form-label">Status</label>
                <select class="form-select" id="status" name="status">
                    <option value="ativo" {% if status == 'ativo' %}selected{% endif %}>Ativos</option>
                    <option value="inativo" {% if status == 'inativo' %}selected{% endif %}>Inativos</option>
                    <option value="todos" {% if status == 'todos' %}selected{% endif %}>Todos</option>
                </select>
            </div>
            <div class="col-md-2 d-grid">
                <button type="submit" class="btn btn-outline-primary">
                    <i class="bi bi-search me-1"></i>
                    Filtrar
                </button>
            </div>
        </div>
    </form>

    {% if instrumentos %}
    <div class="card">
        <div class="table-responsive">
            <table class="table table-hover align-middle mb-0">
                <thead class="table-light">
                    <tr>
                        <th>Nome</th>
                        <th>Código</th>
                        <th>Contexto</th>
                        <th>Faixa Etária</th>
                        <th>Status</th>
                        <th class="text-end">Ações</th>
                    </tr>
                </thead>
                <tbody>
                    {% for instrumento in instrumentos %}
                    <tr>
                        <td>
                            <a href="{{ url_for('instrumentos.visualizar', id=instrumento.id) }}" class="text-decoration-none">
                                <strong>{{ instrumento.nome }}</strong>
                            </a>
                        </td>
                        <td><code>{{ instrumento.codigo }}</code></td>
                        <td>
                    {% set contexto_labels = {
                        'casa': 'Casa',
                        'escola': 'Escola',
                        'clinica': 'Clínica',
                        'hospital': 'Hospital',
                        'geral': 'Geral',
                        'comunidade': 'Comunidade'
                    } %}
                    {% set ctx_label = contexto_labels.get(instrumento.contexto, instrumento.contexto or 'N/D') %}
                    <span class="badge bg-secondary">{{ ctx_label }}</span>
                        </td>
                        <td>{{ instrumento.idade_minima }} - {{ instrumento.idade_maxima }} anos</td>
                        <td>
                            {% if instrumento.ativo %}
                                <span class="badge bg-success">Ativo</span>
                            {% else %}
                                <span class="badge bg-secondary">Inativo</span>
                            {% endif %}
                        </td>
                        <td class="text-end">
                            <div class="btn-group btn-group-sm" role="group">
                                <a href="{{ url_for('instrumentos.visualizar', id=instrumento.id) }}"
                                   class="btn btn-outline-primary"
                                   title="Detalhes">
                                   <i class="bi bi-eye"></i>
                                </a>
                                <a href="{{ url_for('instrumentos.editar', id=instrumento.id) }}"
                                   class="btn btn-outline-warning"
                                   title="Editar">
                                   <i class="bi bi-pencil-square"></i>
                                </a>
                                <form method="POST"
                                      action="{{ url_for('instrumentos.alterar_status', id=instrumento.id, next=request.full_path) }}"
                                      class="d-inline">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                    <button type="submit"
                                            class="btn {% if instrumento.ativo %}btn-outline-danger{% else %}btn-outline-success{% endif %}"
                                            title="{% if instrumento.ativo %}Desativar{% else %}Reativar{% endif %}">
                                        {% if instrumento.ativo %}
                                            <i class="bi bi-slash-circle"></i>
                                        {% else %}
                                            <i class="bi bi-check-circle"></i>
                                        {% endif %}
                                    </button>
                                </form>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% else %}
    <div class="alert alert-info">
        <i class="bi bi-info-circle me-2"></i>
        Nenhum instrumento encontrado com os filtros atuais.
    </div>
    {% endif %}
</div>
{% endblock %}
