{% extends "base.html" %}

{% block title %}PEI - {{ avaliacao.paciente.nome }} - SPM-TO{% endblock %}

{% block content %}
<div class="container">
    <!-- Cabeçalho -->
    <div class="row mb-4">
        <div class="col-md-8">
            <h1><i class="fas fa-file-medical-alt"></i> Plano Educacional Individualizado (PEI)</h1>
            <h3>{{ avaliacao.paciente.nome }}</h3>
        </div>
        <div class="col-md-4 text-end">
            <button onclick="window.print()" class="btn btn-primary">
                <i class="fas fa-print"></i> Imprimir
            </button>
            <a href="{{ url_for('avaliacoes.visualizar', id=avaliacao.id) }}"
               class="btn btn-secondary">
                <i class="fas fa-arrow-left"></i> Voltar
            </a>
            <a href="{{ url_for('relatorios.pei_plano', avaliacao_id=avaliacao.id) }}"
               class="btn btn-outline-success mt-2">
                <i class="bi bi-clipboard-check"></i> Editar Plano
            </a>
        </div>
    </div>

    <!-- Informações Gerais -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5><i class="fas fa-info-circle"></i> Informações da Avaliação</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>Paciente:</strong> {{ avaliacao.paciente.nome }}</p>
                            <p><strong>Data de Nascimento:</strong> {{ avaliacao.paciente.data_nascimento.strftime('%d/%m/%Y') }}</p>
                            <p><strong>Sexo:</strong> {{ 'Masculino' if avaliacao.paciente.sexo == 'M' else 'Feminino' }}</p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Data da Avaliação:</strong> {{ avaliacao.data_avaliacao.strftime('%d/%m/%Y') }}</p>
                            <p><strong>Instrumento:</strong> {{ avaliacao.instrumento.nome }}</p>
                            <p><strong>Respondente:</strong> {{ avaliacao.relacionamento_respondente|capitalize }}</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Resumo de Itens Críticos -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card border-danger">
                <div class="card-header bg-danger text-white">
                    <h5><i class="fas fa-exclamation-triangle"></i> Áreas Prioritárias de Intervenção</h5>
                </div>
                <div class="card-body">
                    {% if itens_criticos %}
                    <p class="text-muted">
                        Os seguintes itens foram identificados como críticos e requerem atenção especial
                        no plano de intervenção:
                    </p>

                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Domínio</th>
                                    <th>Item</th>
                                    <th>Frequência</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in itens_criticos %}
                                <tr>
                                    <td><span class="badge bg-info">{{ item.dominio }}</span></td>
                                    <td>{{ item.questao }}</td>
                                    <td><span class="badge bg-danger">{{ item.valor }}</span></td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="alert alert-success">
                        <i class="fas fa-check-circle"></i>
                        Nenhum item crítico identificado nesta avaliação.
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    {% if scores_spm_table %}
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card border-info">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0"><i class="fas fa-chart-bar"></i> SCORES SPM - Casa</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-sm table-bordered align-middle mb-0">
                            <thead>
                                <tr class="text-center">
                                    <th style="width: 20%;">Categoria</th>
                                    {% for dominio in scores_spm_table.domains %}
                                    <th>{{ dominio }}</th>
                                    {% endfor %}
                                    <th>TOT</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr class="{{ scores_spm_table.patient_row.row_class }}">
                                    <td class="text-start"><strong>{{ scores_spm_table.patient_row.label }}</strong></td>
                                    {% for valor in scores_spm_table.patient_row.values %}
                                    <td class="text-center">{{ valor if valor is not none else '-' }}</td>
                                    {% endfor %}
                                    <td class="text-center">{{ scores_spm_table.patient_row.total }}</td>
                                </tr>
                                {% for row in scores_spm_table.reference_rows %}
                                <tr class="{{ row.row_class }}">
                                    <td class="text-start"><strong>{{ row.label }}</strong></td>
                                    {% for valor in row.values %}
                                    <td class="text-center">{{ valor }}</td>
                                    {% endfor %}
                                    <td class="text-center">{{ row.total }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    <p class="text-muted mb-0"><small>Referência das faixas de pontuação para o instrumento SPM - Casa.</small></p>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Detalhamento por Domínio -->
    <div class="row mb-4">
        <div class="col-md-12">
            <h3><i class="fas fa-list"></i> Detalhamento por Domínio</h3>
        </div>
    </div>

    {% for codigo, data in dominios_respostas.items() %}
    <div class="row mb-3">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header {% if data.dominio.codigo == 'SOC' %}bg-primary{% elif data.dominio.codigo in ['VIS', 'HEA'] %}bg-warning{% else %}bg-info{% endif %} text-white">
                    <h5>{{ data.dominio.nome }}</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-sm table-hover">
                            <thead>
                                <tr>
                                    <th style="width: 60%">Questão</th>
                                    <th>Resposta</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for resp in data.respostas %}
                                <tr {% if resp.critico %}class="table-danger"{% endif %}>
                                    <td>{{ resp.questao.texto }}</td>
                                    <td>
                                        <span class="badge
                                            {% if resp.valor == 'NUNCA' %}bg-success
                                            {% elif resp.valor == 'OCASIONAL' %}bg-info
                                            {% elif resp.valor == 'FREQUENTE' %}bg-warning
                                            {% else %}bg-danger{% endif %}">
                                            {{ resp.valor }}
                                        </span>
                                    </td>
                                    <td>
                                        {% if resp.critico %}
                                            <span class="badge bg-danger">
                                                <i class="fas fa-exclamation-circle"></i> Prioritário
                                            </span>
                                        {% else %}
                                            <span class="badge bg-success">
                                                <i class="fas fa-check"></i> OK
                                            </span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endfor %}

    <!-- Plano de Intervenção Selecionado -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card border-success">
                <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="bi bi-clipboard-check me-2"></i> Plano de Intervenção Selecionado</h5>
                    <a href="{{ url_for('relatorios.pei_plano', avaliacao_id=avaliacao.id) }}" class="btn btn-sm btn-light">
                        <i class="bi bi-pencil-square me-1"></i> Atualizar Plano
                    </a>
                </div>
                <div class="card-body">
                    {% if plano_por_dominio %}
                        {% for dominio, itens in plano_por_dominio.items() %}
                            <div class="mb-3">
                                <h6 class="text-primary">{{ dominio }}</h6>
                                <ul class="mb-0">
                                    {% for item in itens %}
                                    <li>{{ item }}</li>
                                    {% endfor %}
                                </ul>
                            </div>
                        {% endfor %}
                    {% else %}
                        <div class="alert alert-info mb-0">
                            <i class="bi bi-info-circle me-2"></i>
                            Nenhum item de intervenção selecionado. Utilize o botão "Atualizar Plano" para definir
                            estratégias específicas para este paciente.
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Recomendações -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header bg-success text-white">
                    <h5><i class="fas fa-clipboard-check"></i> Recomendações Adicionais</h5>
                </div>
                <div class="card-body">
                    <h6>Estratégias Gerais:</h6>
                    <ul>
                        <li>Estabelecer rotinas previsíveis e estruturadas</li>
                        <li>Fornecer avisos antecipados sobre mudanças ou transições</li>
                        <li>Criar um ambiente com estímulos sensoriais controlados</li>
                        <li>Usar apoios visuais para comunicação e organização</li>
                        <li>Implementar pausas sensoriais regulares</li>
                    </ul>

                    {% if itens_criticos %}
                    <h6 class="mt-3">Intervenções Específicas Sugeridas:</h6>
                    <p class="text-muted">
                        Com base nos itens críticos identificados, recomenda-se:
                    </p>
                    <ul>
                        <li>Avaliação mais aprofundada por terapeuta ocupacional especializado</li>
                        <li>Desenvolvimento de plano de intervenção individualizado</li>
                        <li>Monitoramento próximo das áreas de disfunção identificadas</li>
                        <li>Colaboração entre família, escola e terapeutas</li>
                    </ul>
                    {% endif %}

                    <div class="alert alert-info mt-3">
                        <i class="fas fa-info-circle"></i>
                        <strong>Nota:</strong> Este documento deve ser utilizado como guia inicial.
                        Recomenda-se consulta com profissionais especializados para desenvolver
                        um plano de intervenção completo e personalizado.
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Assinatura -->
    <div class="row">
        <div class="col-md-12">
            <div class="card">
                <div class="card-body">
                    <p><strong>Data do Relatório:</strong> {{ avaliacao.data_conclusao.strftime('%d/%m/%Y') if avaliacao.data_conclusao else 'N/A' }}</p>
                    <p><strong>Elaborado por:</strong> {{ avaliacao.avaliador.nome_completo }}</p>

                    <div class="mt-5">
                        <div class="row">
                            <div class="col-md-6 text-center">
                                <hr style="border-top: 1px solid #000; width: 80%; margin: 0 auto;">
                                <p class="mt-2">Assinatura do Profissional</p>
                            </div>
                            <div class="col-md-6 text-center">
                                <hr style="border-top: 1px solid #000; width: 80%; margin: 0 auto;">
                                <p class="mt-2">Assinatura do Responsável</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
@media print {
    .btn, .navbar, footer {
        display: none !important;
    }
}
</style>
{% endblock %}
